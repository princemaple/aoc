# Day19

## Untitled

<!-- livebook:{"livebook_object":"cell_input","name":"input","type":"textarea","value":"--- scanner 0 ---\n718,-319,-758\n-765,759,419\n-767,-818,386\n10,-99,51\n-691,729,587\n741,426,838\n-519,-675,-349\n-689,-870,398\n-580,-740,-385\n847,344,-830\n434,-791,411\n702,-444,-679\n-477,-808,-423\n406,-784,399\n-263,636,-688\n584,-366,-691\n-256,552,-611\n-265,754,-671\n-758,-751,491\n37,78,-47\n609,-768,472\n906,400,-817\n622,485,781\n-734,844,514\n765,372,771\n949,366,-695\n\n--- scanner 1 ---\n716,649,-468\n523,-512,-705\n730,-406,714\n-425,466,641\n-522,-493,-699\n-387,386,820\n578,-302,713\n-587,-554,-735\n-17,-11,-7\n532,-646,-779\n-378,510,-356\n727,688,-509\n-644,-628,608\n-25,139,138\n637,-309,738\n305,516,805\n-356,383,-412\n-619,-740,555\n722,700,-272\n-681,-738,705\n-454,-596,-661\n-365,386,-303\n607,-554,-704\n-391,425,701\n383,500,853\n265,586,763\n\n--- scanner 2 ---\n-187,81,-88\n329,-636,-509\n-737,-637,795\n-764,424,-483\n680,-666,543\n-706,-633,-655\n675,463,604\n-734,-542,-645\n-729,622,359\n-632,585,469\n412,-813,-542\n337,-707,-597\n637,395,501\n-762,-696,788\n302,884,-694\n-738,-789,691\n381,759,-678\n-40,-95,-54\n-579,560,357\n681,-582,585\n755,-591,451\n-688,-554,-672\n369,837,-560\n-954,350,-449\n-892,375,-581\n711,528,543\n\n--- scanner 3 ---\n-412,600,-682\n101,29,125\n541,654,-701\n-630,-343,-546\n-277,491,673\n539,820,-624\n-322,549,658\n749,906,614\n-724,-315,490\n709,852,579\n574,-510,-612\n704,767,-699\n764,869,429\n-710,-351,531\n-677,-403,-595\n-271,686,-698\n503,-362,-585\n-262,677,589\n-443,748,-738\n786,-356,509\n-582,-366,-528\n508,-415,-547\n963,-361,503\n-788,-507,519\n824,-383,556\n\n--- scanner 4 ---\n-847,-586,607\n-855,-589,531\n-531,-557,-669\n683,-478,-716\n-67,22,32\n561,755,620\n549,604,534\n-820,755,-622\n370,581,-696\n-477,897,527\n667,-492,-582\n-695,736,-647\n-505,-672,-636\n551,773,501\n391,669,-702\n581,-732,580\n-767,616,-603\n548,-723,584\n505,-673,543\n-496,-617,-677\n638,-549,-668\n325,548,-637\n-541,831,617\n-583,887,700\n-844,-594,400\n\n--- scanner 5 ---\n-719,-344,-322\n-945,-745,519\n-547,-403,-366\n-747,-747,518\n-548,567,-462\n699,-585,-603\n542,-757,822\n-573,688,600\n440,843,-635\n-547,404,-585\n372,642,723\n683,-677,-688\n-557,788,714\n-595,496,-456\n448,-783,749\n402,744,-634\n388,-677,824\n-148,-10,56\n708,-779,-653\n-39,-139,-54\n296,748,-674\n386,594,758\n-658,-531,-358\n-562,759,749\n-860,-720,672\n370,459,688\n\n--- scanner 6 ---\n775,557,-419\n787,675,-341\n675,-667,-360\n-376,650,-743\n-477,-566,-614\n780,-563,-434\n913,353,425\n-532,-645,-667\n-433,-537,-737\n835,-752,530\n-315,825,-766\n791,310,391\n41,40,59\n854,541,-294\n926,412,369\n-742,518,451\n761,-745,627\n-685,637,510\n861,-758,696\n-638,-563,636\n-303,853,-759\n-627,-588,387\n674,-711,-429\n-577,-588,427\n-32,-66,-71\n-675,494,397\n\n--- scanner 7 ---\n-551,-846,-480\n574,-375,689\n-643,710,-467\n782,449,688\n573,-555,702\n661,-413,-679\n-599,632,-526\n531,-393,716\n795,-339,-670\n688,376,662\n-612,537,535\n842,374,582\n-394,-526,512\n703,-414,-595\n-539,-609,-475\n-598,595,633\n-602,670,560\n844,440,-689\n-500,-650,-486\n-501,-463,517\n-12,79,-39\n-485,-505,613\n858,475,-737\n860,510,-554\n100,-27,-148\n-500,661,-418\n\n--- scanner 8 ---\n684,384,758\n667,-321,-509\n-701,-582,773\n-630,-629,767\n764,-431,-565\n-604,490,-800\n786,392,901\n-72,86,-85\n-934,-513,-497\n773,468,865\n797,-664,822\n44,-8,56\n693,-608,711\n594,-407,-515\n-573,557,-674\n694,487,-881\n-911,-494,-352\n-793,-630,644\n-846,-525,-382\n662,465,-695\n-791,655,417\n669,439,-800\n-769,607,399\n-838,696,404\n-664,542,-625\n641,-600,759\n\n--- scanner 9 ---\n-370,-680,-848\n691,-559,-817\n-795,531,586\n610,-491,-737\n433,840,-369\n-746,482,729\n655,-710,458\n654,-819,475\n-524,752,-758\n602,-739,370\n-374,-640,-742\n-462,-764,551\n500,735,-378\n125,63,-67\n-687,560,685\n823,297,666\n-673,-812,535\n20,-46,87\n742,334,752\n-659,682,-774\n-275,-641,-704\n582,-411,-841\n-548,-723,567\n-476,717,-772\n381,828,-447\n681,344,625\n\n--- scanner 10 ---\n-17,-120,-122\n690,285,-422\n-704,-549,-717\n-517,706,-757\n597,604,537\n594,398,-404\n587,-600,428\n-629,-622,-721\n330,-805,-485\n502,-692,412\n372,-897,-374\n-578,489,461\n552,-498,403\n-567,455,572\n-923,-520,569\n659,415,523\n474,-752,-413\n-492,624,-635\n668,406,-431\n-925,-600,723\n-762,-647,-731\n683,599,469\n-549,736,-735\n-850,-494,663\n-158,-40,-18\n-618,523,520\n\n--- scanner 11 ---\n855,-769,669\n839,428,-390\n-593,-814,-625\n805,456,-328\n-562,-463,659\n788,331,418\n-631,683,650\n-637,769,723\n-794,596,-855\n760,-615,-595\n-764,565,-790\n-581,659,820\n-565,-455,583\n779,-490,-570\n-570,-466,452\n866,296,493\n-648,-805,-584\n-533,-779,-617\n640,-543,-551\n-649,577,-878\n921,-833,579\n819,420,-323\n-9,-125,3\n138,-3,-46\n911,-727,752\n831,451,462\n\n--- scanner 12 ---\n659,-435,-675\n533,-764,542\n-799,-621,-805\n-737,633,758\n580,-420,-678\n299,854,462\n-516,498,-776\n-721,-517,561\n-817,685,653\n-416,467,-777\n-647,472,-825\n-85,-25,-135\n484,-715,399\n346,712,503\n386,718,-630\n-708,686,670\n-762,-431,577\n77,76,-10\n-660,-512,-779\n336,773,376\n562,-656,443\n680,-328,-776\n538,729,-572\n-810,-582,-827\n-810,-642,593\n597,710,-596\n\n--- scanner 13 ---\n144,114,178\n-650,535,594\n-6,-22,41\n673,514,538\n492,-330,750\n496,-436,710\n744,561,532\n-569,-361,629\n-311,-809,-770\n646,-420,-682\n598,-406,-647\n397,-474,711\n-460,-337,481\n781,-404,-612\n-488,-441,561\n-378,-800,-665\n481,528,-673\n-598,543,546\n-754,479,483\n-259,-731,-758\n452,523,-638\n836,513,661\n-338,392,-745\n552,539,-524\n-345,364,-757\n-361,567,-684\n\n--- scanner 14 ---\n254,-509,578\n-822,-468,-448\n-430,642,354\n491,-662,-692\n-896,-300,-418\n282,-473,753\n755,769,417\n-502,551,410\n-462,617,493\n-655,-639,828\n-865,-395,-333\n-155,130,77\n634,-652,-805\n558,761,458\n818,814,-811\n716,949,-833\n-650,-563,828\n23,123,-43\n-396,790,-423\n-387,730,-625\n240,-397,587\n-394,807,-541\n610,-719,-751\n603,762,346\n775,936,-777\n-831,-652,834\n\n--- scanner 15 ---\n697,-915,554\n664,-863,-572\n284,538,-310\n-406,416,-430\n540,474,894\n-799,-910,532\n503,571,784\n775,-759,542\n569,-900,-505\n-871,465,562\n-521,-851,-524\n711,-951,513\n-587,-756,-589\n-516,-904,-562\n-976,-905,526\n250,478,-269\n-719,466,458\n246,359,-230\n-778,441,465\n-147,-48,130\n617,-923,-523\n478,624,896\n-837,-883,579\n-446,374,-360\n-524,326,-344\n-8,-164,72\n\n--- scanner 16 ---\n-938,-437,336\n-719,-437,-471\n-701,809,518\n-166,-14,-78\n277,-573,-353\n-982,-609,277\n-669,550,-910\n422,-554,-330\n423,828,-624\n611,-680,717\n-616,793,610\n-946,-548,464\n529,901,520\n538,802,-591\n-842,-438,-634\n10,152,-110\n545,-735,624\n-848,-485,-563\n485,-763,698\n-630,406,-815\n-68,72,43\n639,790,520\n307,-542,-418\n-651,818,712\n770,927,533\n-670,512,-811\n478,837,-583\n\n--- scanner 17 ---\n-814,-643,-935\n-639,633,355\n-771,567,-548\n722,-899,817\n829,841,383\n-677,-656,-804\n661,-712,781\n469,827,-792\n-20,-47,-32\n876,-478,-650\n793,-459,-776\n520,877,-716\n-696,-658,536\n550,-840,773\n-788,-656,-694\n-680,-566,451\n917,838,390\n770,862,292\n848,-552,-710\n-571,638,441\n-705,-464,486\n-585,449,379\n-817,617,-461\n83,57,-151\n435,857,-565\n-760,636,-554\n\n--- scanner 18 ---\n480,-514,280\n-563,556,-786\n-610,-718,-593\n942,393,-699\n824,-603,-563\n-365,617,363\n-500,-703,391\n-662,-670,-585\n-733,606,-762\n965,538,-680\n129,98,-119\n385,-553,424\n-636,550,-872\n-766,-781,-529\n-496,622,352\n671,539,702\n-472,-783,287\n-581,-635,311\n704,654,676\n877,423,-668\n661,-726,-564\n712,594,711\n484,-554,386\n-572,625,360\n7,25,18\n732,-732,-611\n\n--- scanner 19 ---\n-783,-390,859\n-678,-565,-669\n-885,650,-544\n-719,-568,885\n-849,520,671\n784,262,529\n-38,-8,134\n-783,-477,-693\n-741,-410,-654\n676,307,-418\n726,-766,-614\n587,312,-349\n741,-717,-523\n761,396,456\n-825,592,582\n56,-110,-18\n-747,-495,917\n741,-677,716\n-827,568,-574\n659,-536,746\n656,-608,615\n-744,686,-608\n676,277,499\n-834,468,686\n793,-892,-583\n628,325,-396\n\n--- scanner 20 ---\n391,-557,359\n288,-480,438\n670,486,-972\n-908,384,-809\n-781,394,215\n-789,-466,756\n-391,-634,-797\n404,-495,375\n-399,-745,-925\n486,-347,-583\n639,-432,-608\n-39,-36,-80\n-355,-573,-984\n764,813,738\n-774,407,-882\n485,-545,-581\n-880,-525,777\n-782,-378,753\n654,575,-784\n695,834,549\n-853,399,337\n758,815,672\n-893,492,-839\n-720,328,288\n668,623,-834\n\n--- scanner 21 ---\n736,971,639\n-701,-325,885\n352,-657,-361\n608,701,-416\n-732,416,796\n-648,678,-539\n668,-727,557\n881,948,620\n-489,-594,-750\n433,-632,-313\n-779,-400,920\n718,-557,533\n-565,692,-668\n538,-625,-339\n-345,-621,-709\n-718,421,760\n-752,483,788\n851,883,651\n433,641,-364\n-744,-369,765\n-689,598,-670\n559,610,-431\n724,-630,447\n-591,-597,-703\n49,90,-4\n\n--- scanner 22 ---\n-376,-708,-824\n-471,752,-811\n-405,-474,567\n777,-829,-787\n437,-672,602\n-371,-400,377\n818,-843,-823\n769,739,593\n789,-907,-631\n16,41,124\n866,646,569\n-567,492,597\n-497,723,-681\n547,-635,699\n-503,-425,439\n-349,-845,-790\n-354,809,-689\n873,587,594\n-577,583,625\n752,705,-755\n125,-121,38\n799,667,-782\n-594,504,643\n435,-610,752\n-394,-707,-807\n805,844,-777\n\n--- scanner 23 ---\n-899,-920,-421\n759,-699,-895\n-529,-668,447\n-873,570,-777\n-705,339,462\n-341,-579,431\n703,626,534\n-730,254,615\n829,-730,-795\n368,641,-746\n-479,-716,433\n614,-602,549\n-738,578,-918\n714,-755,-770\n-839,-927,-446\n545,674,-829\n774,637,385\n474,586,-821\n54,-114,-37\n528,-558,571\n803,642,420\n-873,-836,-441\n-96,-21,-140\n-808,616,-746\n631,-670,579\n-732,452,616\n\n--- scanner 24 ---\n-142,-98,-139\n-784,-668,-807\n-484,595,534\n294,-372,-467\n-485,553,618\n367,-575,-483\n386,792,-500\n527,-547,430\n378,-536,359\n413,-531,330\n-863,-684,-932\n439,396,659\n-22,-13,3\n369,412,524\n-454,553,-576\n-796,-550,-885\n-490,614,-511\n-753,-532,765\n-836,-499,588\n281,801,-433\n404,398,476\n293,723,-381\n306,-400,-460\n-828,-587,659\n-410,461,543\n-528,511,-443\n\n--- scanner 25 ---\n-640,-770,684\n-494,649,532\n-340,-750,-549\n-585,634,483\n-597,395,-765\n-554,701,357\n644,564,641\n775,567,713\n-358,-684,-386\n768,-532,-512\n726,-443,-630\n711,669,-694\n816,605,-644\n-625,-833,839\n-309,-627,-485\n914,-811,681\n-517,526,-724\n31,-180,63\n622,600,-696\n-664,-875,772\n53,-31,-91\n888,-875,859\n-503,397,-641\n771,-477,-702\n946,-839,754\n745,649,572\n\n--- scanner 26 ---\n837,-567,790\n579,541,-651\n674,-520,-664\n736,752,806\n-622,953,738\n-675,-567,495\n616,-618,-650\n-418,-362,-418\n771,704,792\n-460,-270,-307\n835,-647,636\n-661,858,882\n-64,144,114\n-621,854,776\n-640,-669,470\n-793,555,-501\n-745,766,-517\n701,569,808\n-590,-475,479\n-562,-415,-346\n501,482,-695\n24,65,-66\n541,-545,-654\n762,-673,730\n550,433,-552\n-704,680,-533\n\n--- scanner 27 ---\n406,-785,636\n-566,-637,545\n-530,-710,-444\n700,-600,-643\n726,587,-880\n-568,369,-790\n544,-783,499\n-532,-571,-422\n-378,748,630\n-549,-667,613\n-534,487,-873\n-356,730,582\n594,-769,547\n775,-604,-659\n711,535,-895\n-309,743,541\n539,778,630\n622,463,-871\n582,-633,-663\n186,-27,-42\n496,659,715\n-504,405,-931\n-576,-538,-479\n6,-129,-105\n569,793,738\n-463,-645,657\n\n--- scanner 28 ---\n635,658,698\n598,-709,488\n-639,-353,578\n-661,703,770\n-686,-359,649\n-576,-255,-449\n86,-2,35\n523,666,595\n442,-772,-437\n633,790,-462\n-26,173,-1\n550,-727,510\n639,-722,441\n-687,-263,-321\n465,-638,-364\n-687,-482,486\n544,806,-274\n-487,621,-665\n-289,622,-663\n-677,817,870\n-515,-219,-262\n-672,852,841\n-374,775,-638\n550,-757,-407\n567,688,681\n681,804,-412\n"} -->

<!-- livebook:{"reevaluate_automatically":true} -->

```elixir
data =
  "input"
  |> IO.getn(1_000_000)
  |> String.trim()
  |> String.split(~r/^--- /m, trim: true)
  |> Enum.map(
    &(&1
      |> String.split(" ---", trim: true)
      |> then(fn ["scanner " <> scanner, beacons] ->
        {String.to_integer(scanner),
         beacons
         |> String.split(["\r\n", "\n"], trim: true)
         |> Enum.map(fn beacon ->
           beacon |> String.split(",") |> Enum.map(fn n -> String.to_integer(n) end)
         end)}
      end))
  )
  |> Map.new()

1
```

<!-- livebook:{"reevaluate_automatically":true} -->

```elixir
defmodule D18 do
  def prepare(data) do
    data
    |> Enum.map(fn {scanner, beacons} -> {scanner, {length(beacons), quadrants(beacons)}} end)
    |> Map.new()
  end

  @rs [
    &D18.not_rotate/1,
    &D18.rotate_x_cw/1,
    &D18.rotate_y_cw/1,
    &D18.rotate_z_cw/1,
    &D18.rotate_x_ac/1,
    &D18.rotate_y_ac/1,
    &D18.rotate_z_ac/1
  ]

  def quadrants(beacons) do
    beacons
    |> Stream.map(fn beacon ->
      for r1 <- @rs, r2 <- @rs, r3 <- @rs do
        beacon |> r1.() |> r2.() |> r3.()
      end
      |> Enum.uniq()
    end)
    |> Stream.zip()
    |> Enum.map(&Tuple.to_list/1)
  end

  def not_rotate(point), do: point

  def rotate_x_cw([x, y, z]) do
    [x, z, -y]
  end

  def rotate_y_cw([x, y, z]) do
    [-z, y, x]
  end

  def rotate_z_cw([x, y, z]) do
    [y, -x, z]
  end

  def rotate_x_ac([x, y, z]) do
    [x, -z, y]
  end

  def rotate_y_ac([x, y, z]) do
    [z, y, -x]
  end

  def rotate_z_ac([x, y, z]) do
    [-y, x, z]
  end

  def detect_connection([q1 | _qs1], qs2) do
    Enum.find_value(qs2, fn q2 ->
      for [x1, y1, z1] <- q1, [x2, y2, z2] <- q2 do
        {x1 - x2, y1 - y2, z1 - z2}
      end
      |> Enum.frequencies()
      |> Enum.find(&(elem(&1, 1) >= 12))
      |> then(fn
        nil -> nil
        {_, count} -> count
      end)
    end)
  end

  def total({s1, s2, count}, {sum, seen}, data) do
    {sum + if(s1 in seen, do: 0, else: elem(data[s1], 0)) +
       if(s2 in seen, do: 0, else: elem(data[s2], 0)) - count,
     seen
     |> MapSet.put(s1)
     |> MapSet.put(s2)}
  end

  def solve1(data) do
    data = prepare(data)

    for {s1, {_, qs1}} <- data, {s2, {_, qs2}} <- data, s1 < s2 do
      {s1, s2, detect_connection(qs1, qs2)}
    end
    |> Enum.reject(&is_nil(elem(&1, 2)))
    |> Enum.reduce({0, MapSet.new()}, &total(&1, &2, data))
  end

  def detect_connection2(q1, qs2, s2) do
    Enum.find_value(Enum.with_index(qs2), fn {q2, i2} ->
      for [x1, y1, z1] = p1 <- q1, [x2, y2, z2] = p2 <- q2 do
        {{x1 - x2, y1 - y2, z1 - z2}, {p1, p2}}
      end
      |> Enum.group_by(&elem(&1, 0), &elem(&1, 1))
      |> Enum.find(&(length(elem(&1, 1)) >= 12))
      |> then(fn
        nil ->
          nil

        {_diff, [point | _points]} ->
          Agent.update(P2, &Map.put(&1, s2, i2))
          point
      end)
    end)
  end

  def locate([{s1, s2, {[x1, y1, z1], [x2, y2, z2]}} = item | rest], map) do
    if !Map.has_key?(map, s1) and Map.has_key?(map, s2) do
      [x, y, z] = map[s2]
      {rest, Map.put(map, s1, [x + x2 - x1, y + y2 - y1, z + z2 - z1])}
    else
      if !Map.has_key?(map, s2) and Map.has_key?(map, s1) do
        [x, y, z] = map[s1]
        {rest, Map.put(map, s2, [x + x1 - x2, y + y1 - y2, z + z1 - z2])}
      else
        {rest ++ [item], map}
      end
    end
  end

  def connect([{s1, {_, qs1}} | rest], acc \\ []) do
    Enum.reduce(rest, acc, fn {s2, {_, qs2}} = item, acc ->
      i1 = Agent.get(P2, &Map.get(&1, s1))
      i2 = Agent.get(P2, &Map.get(&1, s2))

      case {i1, i2} do
        {i1, nil} when not is_nil(i1) ->
          connect(
            [item | rest -- [item]],
            [{s1, s2, detect_connection2(Enum.at(qs1, i1), qs2, s2)} | acc]
          )

        {_i1, _i2} ->
          acc
      end
    end)
  end

  def solve2(data) do
    data = prepare(data)

    Agent.start_link(fn -> %{0 => 0} end, name: P2)

    coords =
      data
      |> Enum.to_list()
      |> connect([])
      |> Enum.reject(&is_nil(elem(&1, 2)))
      |> IO.inspect()
      |> Enum.sort()
      |> then(fn [{s1, s2, {[x1, y1, z1], [x2, y2, z2]}} | rest] ->
        Stream.iterate({rest, %{s1 => [0, 0, 0], s2 => [-x2 + x1, -y2 + y1, -z2 + z1]}}, fn {rest,
                                                                                             map} ->
          locate(rest, map)
        end)
        |> Enum.find_value(fn
          {[], map} -> map
          _ -> false
        end)
      end)
      |> IO.inspect()

    for {s1, [x1, y1, z1]} <- coords, {s2, [x2, y2, z2]} <- coords, s1 < s2 do
      abs(x2 - x1) + abs(y2 - y1) + abs(z2 - z1)
    end
    |> Enum.max()
  end
end
```

## P1

<!-- livebook:{"reevaluate_automatically":true} -->

```elixir
D18.solve1(data)
```

## P2

<!-- livebook:{"reevaluate_automatically":true} -->

```elixir
Agent.stop(P2)
```

<!-- livebook:{"reevaluate_automatically":true} -->

```elixir
D18.solve2(data)
```
